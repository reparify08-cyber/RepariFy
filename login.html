<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login - RepariFy</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #f8f9fa;
    padding-top: 80px;
  }
  .container {
    max-width: 450px;
    background-color: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
  }
  h2 {
    color: #007bff;
    margin-bottom: 20px;
    font-weight: 700;
  }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">RepariFy</a>
  </div>
</nav>

<div class="container">
  <h2>Login to RepariFy</h2>
  <form id="loginForm">
    <div class="mb-3">
      <label for="email" class="form-label">Email or User ID <span class="text-danger">*</span></label>
      <input type="email" id="email" name="email" class="form-control" placeholder="Enter your email" required />
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
      <input type="password" id="password" name="password" class="form-control" required />
    </div>
    <button type="submit" class="btn btn-primary w-100 btn-lg">Login</button>
  </form>
  <div class="mt-3 text-center">
    <p>New user? <a href="register.html">Register here</a></p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBCalxCVKnVERmpLnnCjT0X9Basy3uw7o",
    authDomain: "reparify-4db99.firebaseapp.com",
    projectId: "reparify-4db99",
    storageBucket: "reparify-4db99.appspot.com",
    messagingSenderId: "1039139563247",
    appId: "1:1039139563247:web:b93c63206f03433de11d1a",
    measurementId: "G-QP5QS2WJJX"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = e.target.email.value.trim().toLowerCase();
    const password = e.target.password.value;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // Admin login check
      if (email === 'admin@repari.fy') {
        window.location.href = 'admin.html';
        return;
      }

      // Check Shop document exists and authorized
      const docSnap = await getDoc(doc(db, 'shops', user.uid));
      if (!docSnap.exists()) {
        alert('Shop not found. Please register first.');
        return;
      }
      const userData = docSnap.data();

      // Check approval
      if (!userData.isApproved) {
        alert('Your registration is pending approval from admin.');
        return;
      }

      // Check subscription expiry
      if (userData.subscriptionEnds) {
        const expiryDate = userData.subscriptionEnds.toDate();
        const now = new Date();
        if (expiryDate < now) {
          alert('Your subscription has expired. Please contact admin for renewal.');
          return;
        }
      }

      // Redirect to dashboard
      window.location.href = 'dashboard.html';

    } catch (error) {
      alert('Login failed: ' + error.message);
      console.error(error);
    }
  });
</script>

</body>
</html>
