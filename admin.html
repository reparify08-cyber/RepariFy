<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - RepariFy</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    font-family: 'Poppins', sans-serif;
    padding-top: 80px;
    background-color: #f8f9fa;
  }
  .container {
    max-width: 1100px;
  }
  h2 {
    font-weight: 700;
    color: #007bff;
    margin-bottom: 20px;
  }
  .table-responsive {
    max-height: 600px;
    overflow-y: auto;
  }
  .btn-primary, .btn-success, .btn-danger {
    min-width: 110px;
  }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="#">RepariFy Admin Panel</a>
  </div>
</nav>

<div class="container">
  <h2>Manage Shop Registrations & Plans</h2>
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>Shop ID</th>
          <th>Shop Name</th>
          <th>Email</th>
          <th>Mobile</th>
          <th>Plan</th>
          <th>Subscription Ends</th>
          <th>Approval Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="shopListBody">
        <tr><td colspan="8" class="text-center text-muted">Loading shops...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBCalxCVKnVERmpLnnCjT0X9Basy3uw7o",
    authDomain: "reparify-4db99.firebaseapp.com",
    projectId: "reparify-4db99",
    storageBucket: "reparify-4db99.appspot.com",
    messagingSenderId: "1039139563247",
    appId: "1:1039139563247:web:b93c63206f03433de11d1a",
    measurementId: "G-QP5QS2WJJX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore();

  const shopListBody = document.getElementById('shopListBody');

  async function loadShopList() {
    const shopsSnap = await getDocs(collection(db, 'shops'));
    if(shopsSnap.empty){
      shopListBody.innerHTML = `<tr><td colspan="8" class="text-center">No shops found.</td></tr>`;
    } else {
      shopListBody.innerHTML = '';
      shopsSnap.forEach(docSnap => {
        const data = docSnap.data();
        const shopId = docSnap.id;
        const planEndsDate = data.subscriptionEnds ? data.subscriptionEnds.toDate().toLocaleDateString() : 'N/A';
        const approvedText = data.isApproved ? `<span class='badge bg-success'>Approved</span>` : `<span class='badge bg-warning'>Pending</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${shopId}</td>
          <td>${data.shopName}</td>
          <td>${data.email}</td>
          <td>${data.mobileNo}</td>
          <td>
            <select class="form-select" data-shop-id="${shopId}">
              <option value="trial" ${data.subscriptionStatus === 'Trial' ? 'selected' : ''}>Trial</option>
              <option value="6months" ${data.subscriptionStatus === '6months' ? 'selected' : ''}>6 Months</option>
              <option value="1year" ${data.subscriptionStatus === '1year' ? 'selected' : ''}>1 Year</option>
              <option value="2years" ${data.subscriptionStatus === '2years' ? 'selected' : ''}>2 Years</option>
            </select>
          </td>
          <td>${planEndsDate}</td>
          <td>${approvedText}</td>
          <td>
            <button class="btn btn-success btn-sm approve-btn" data-shop-id="${shopId}">Approve</button>
            <button class="btn btn-danger btn-sm revoke-btn" data-shop-id="${shopId}">Revoke</button>
          </td>
        `;
        shopListBody.appendChild(tr);
      });

      document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', () => handleApproval(btn.dataset.shopId, true));
      });
      document.querySelectorAll('.revoke-btn').forEach(btn => {
        btn.addEventListener('click', () => handleApproval(btn.dataset.shopId, false));
      });
      document.querySelectorAll('select.form-select').forEach(sel => {
        sel.addEventListener('change', (e) => handlePlanChange(e.target.dataset.shopId, e.target.value));
      });
    }
  }

  async function handleApproval(shopId, approved) {
    if(!confirm(`${approved ? 'Approve' : 'Revoke'} this shop?`)) return;
    try {
      let subscriptionEnds = null;
      let subscriptionStatus = 'Trial';
      if(approved){
        const selectBox = document.querySelector(`select[data-shop-id="${shopId}"]`);
        subscriptionStatus = selectBox ? selectBox.value : 'Trial';
        if(subscriptionStatus === '6months'){
          subscriptionEnds = new Date(Date.now() + 6*30*24*60*60*1000);
        } else if(subscriptionStatus === '1year'){
          subscriptionEnds = new Date(Date.now() + 365*24*60*60*1000);
        } else if(subscriptionStatus === '2years'){
          subscriptionEnds = new Date(Date.now() + 2*365*24*60*60*1000);
        } else {
          subscriptionEnds = new Date(Date.now() + 7*24*60*60*1000);
        }
      }
      await updateDoc(doc(db, 'shops', shopId), {
        isApproved: approved,
        subscriptionStatus: approved ? subscriptionStatus : 'Not Approved',
        subscriptionEnds: subscriptionEnds ? subscriptionEnds : null,
        updatedAt: serverTimestamp()
      });
      alert(`Shop has been ${approved ? 'approved' : 'revoked'} successfully`);
      loadShopList();
    } catch(error){
      alert('Failed to update status: ' + error.message);
      console.error(error);
    }
  }

  async function handlePlanChange(shopId, newPlan) {
    try {
      let subscriptionEnds = null;
      if(newPlan === '6months'){
        subscriptionEnds = new Date(Date.now() + 6*30*24*60*60*1000);
      } else if(newPlan === '1year'){
        subscriptionEnds = new Date(Date.now() + 365*24*60*60*1000);
      } else if(newPlan === '2years'){
        subscriptionEnds = new Date(Date.now() + 2*365*24*60*60*1000);
      } else if(newPlan === 'trial'){
        subscriptionEnds = new Date(Date.now() + 7*24*60*60*1000);
      }
      await updateDoc(doc(db, 'shops', shopId), {
        subscriptionStatus: newPlan,
        subscriptionEnds: subscriptionEnds,
        updatedAt: serverTimestamp()
      });
      alert(`Plan updated successfully`);
      loadShopList();
    } catch(error){
      alert('Failed to update plan: ' + error.message);
      console.error(error);
    }
  }

  window.onload = () => loadShopList();
</script>

</body>
</html>
