<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - RepariFy</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { font-family: 'Poppins', sans-serif; background: #f8f9fa; padding-top: 80px; }
  .container { max-width: 1300px; }
  h2 { font-weight: 700; color: #007bff; margin-bottom: 20px; }
  .table-responsive { max-height: 550px; overflow-y: auto; margin-bottom: 30px; }
  .btn-primary, .btn-success, .btn-danger { min-width: 100px; }
  .filter-group, .export-group, .plan-pricing-group { margin-bottom: 20px; }
  .search-box input { max-width: 300px; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-dark">
  <div class="container d-flex justify-content-between align-items-center">
    <a class="navbar-brand" href="#">RepariFy Admin Panel</a>
    <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
  </div>
</nav>

<div class="container">
  <h2>Manage Shop Registrations & Plans</h2>

  <div class="row">
    <div class="col-md-6 filter-group d-flex align-items-center gap-3">
      <input class="form-control search-box" type="search" placeholder="Search by Mobile Number or Shop Name" id="searchInput" />
      <select id="filterSelect" class="form-select" style="max-width: 220px;">
        <option value="all">All Shops</option>
        <option value="approved">Approved</option>
        <option value="notapproved">Not Approved</option>
        <option value="trial">Trial Plan</option>
        <option value="subscription">Subscribed</option>
      </select>
      <button id="clearFilterBtn" class="btn btn-secondary btn-sm">Clear Search & Filter</button>
    </div>

    <div class="col-md-6 export-group d-flex justify-content-end gap-2">
      <button id="exportCsvBtn" class="btn btn-success btn-sm">Export CSV</button>
      <button id="exportPdfBtn" class="btn btn-danger btn-sm">Export PDF</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle text-center" id="shopsTable">
      <thead class="table-dark">
        <tr>
          <th>Shop ID</th>
          <th>Shop Name</th>
          <th>Email</th>
          <th>Mobile</th>
          <th>Plan</th>
          <th>Price (₹)</th>
          <th>Subscription Ends</th>
          <th>Approval Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="shopListBody">
        <tr><td colspan="9" class="text-center text-muted">Loading shops...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="plan-pricing-group">
    <h4>Manage Product Prices</h4>
    <div class="row g-3 align-items-center">
      <div class="col-auto">
        <label class="form-label">6 Months Price:</label>
        <input type="number" class="form-control" id="plan6m" min="0" />
      </div>
      <div class="col-auto">
        <label class="form-label">1 Year Price:</label>
        <input type="number" class="form-control" id="plan1y" min="0" />
      </div>
      <div class="col-auto">
        <label class="form-label">2 Years Price:</label>
        <input type="number" class="form-control" id="plan2y" min="0" />
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" id="savePlanPricesBtn">Save Prices</button>
      </div>
      <div id="planStatusMsg" class="mt-2"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBCalxCVKnVERmpLnnCjT0X9Basy3uw7o",
    authDomain: "reparify-4db99.firebaseapp.com",
    projectId: "reparify-4db99",
    storageBucket: "reparify-4db99.appspot.com",
    messagingSenderId: "1039139563247",
    appId: "1:1039139563247:web:b93c63206f03433de11d1a",
    measurementId: "G-QP5QS2WJJX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore();
  const auth = getAuth();

  const shopListBody = document.getElementById('shopListBody');
  const shopsTable = document.getElementById('shopsTable');
  let shopsData = [];

  // Logout Button fix
  document.getElementById('logoutBtn').addEventListener('click', () => {
    signOut(auth).then(() => window.location.href = 'login.html');
  });

  // Auth check
  onAuthStateChanged(auth, (user) => {
    if (!user || user.email !== 'admin@repari.fy') {
      window.location.href = 'login.html';
    }
  });

  // Load shops realtime
  onSnapshot(collection(db, 'shops'), (snapshot) => {
    shopsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderTable(shopsData);
  }, (err) => {
    shopListBody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Failed to load shop data</td></tr>`;
  });

  function renderTable(data) {
    if (data.length === 0) {
      shopListBody.innerHTML = `<tr><td colspan="9" class="text-center">No matching records</td></tr>`;
      return;
    }
    shopListBody.innerHTML = '';
    data.forEach(shop => {
      const planPrices = {
        trial: 'Free',
        '6months': document.getElementById('plan6m').value || 'N/A',
        '1year': document.getElementById('plan1y').value || 'N/A',
        '2years': document.getElementById('plan2y').value || 'N/A'
      };
      const price = planPrices[shop.subscriptionStatus?.toLowerCase()] || 'N/A';
      const subEnds = shop.subscriptionEnds?.toDate ? shop.subscriptionEnds.toDate().toLocaleDateString() : 'N/A';
      const approvedBadge = shop.isApproved ? `<span class="badge bg-success">Approved</span>` : `<span class="badge bg-warning">Pending</span>`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${shop.id}</td>
        <td>${shop.shopName || '-'}</td>
        <td>${shop.email || '-'}</td>
        <td>${shop.mobileNo || '-'}</td>
        <td><select class="form-select form-select-sm" data-id="${shop.id}">
          <option value="trial" ${shop.subscriptionStatus === 'trial' ? 'selected' : ''}>Trial</option>
          <option value="6months" ${shop.subscriptionStatus === '6months' ? 'selected' : ''}>6 Months</option>
          <option value="1year" ${shop.subscriptionStatus === '1year' ? 'selected' : ''}>1 Year</option>
          <option value="2years" ${shop.subscriptionStatus === '2years' ? 'selected' : ''}>2 Years</option>
        </select></td>
        <td>₹${price}</td>
        <td>${subEnds}</td>
        <td>${approvedBadge}</td>
        <td>
          <button class="btn btn-success btn-sm approve-btn" data-id="${shop.id}">Approve</button>
          <button class="btn btn-danger btn-sm revoke-btn" data-id="${shop.id}">Revoke</button>
        </td>
      `;
      shopListBody.appendChild(tr);
    });
    attachEvents();
  }

  function attachEvents() {
    document.querySelectorAll('.approve-btn').forEach(btn => {
      btn.onclick = () => handleApproval(btn.dataset.id, true);
    });
    document.querySelectorAll('.revoke-btn').forEach(btn => {
      btn.onclick = () => handleApproval(btn.dataset.id, false);
    });
    document.querySelectorAll('select.form-select').forEach(select => {
      select.onchange = (e) => handlePlanChange(e.target.dataset.id, e.target.value);
    });
  }

  async function handleApproval(id, approve) {
    if (!confirm(`Are you sure to ${approve ? 'approve' : 'revoke'} this shop?`)) return;
    const now = new Date();
    let subscriptionEnds = null;
    if (approve) {
      const plan = document.querySelector(`select[data-id="${id}"]`).value;
      switch (plan) {
        case '6months': subscriptionEnds = new Date(now.getTime() + 6 * 30 * 24 * 60 * 60 * 1000); break;
        case '1year': subscriptionEnds = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000); break;
        case '2years': subscriptionEnds = new Date(now.getTime() + 2 * 365 * 24 * 60 * 60 * 1000); break;
        default: subscriptionEnds = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      }
    }
    try {
      await updateDoc(doc(db, 'shops', id), {
        isApproved: approve,
        subscriptionStatus: approve ? document.querySelector(`select[data-id="${id}"]`).value : 'revoked',
        subscriptionEnds,
        updatedAt: serverTimestamp()
      });
      alert(`Shop ${approve ? 'approved' : 'revoked'} successfully.`);
    } catch (error) {
      alert('Error updating shop status: ' + error.message);
    }
  }

  async function handlePlanChange(id, plan) {
    const now = new Date();
    let subscriptionEnds;
    switch (plan) {
      case '6months': subscriptionEnds = new Date(now.getTime() + 6 * 30 * 24 * 60 * 60 * 1000); break;
      case '1year': subscriptionEnds = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000); break;
      case '2years': subscriptionEnds = new Date(now.getTime() + 2 * 365 * 24 * 60 * 60 * 1000); break;
      default: subscriptionEnds = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    }
    try {
      await updateDoc(doc(db, 'shops', id), {
        subscriptionStatus: plan,
        subscriptionEnds,
        updatedAt: serverTimestamp()
      });
      alert('Plan updated successfully.');
    } catch (error) {
      alert('Error updating plan: ' + error.message);
    }
  }

  // Search and Filter
  const searchInput = document.getElementById('searchInput');
  const filterSelect = document.getElementById('filterSelect');
  const clearFilterBtn = document.getElementById('clearFilterBtn');

  searchInput.addEventListener('input', applyFilters);
  filterSelect.addEventListener('change', applyFilters);
  clearFilterBtn.addEventListener('click', () => {
    searchInput.value = '';
    filterSelect.value = 'all';
    renderTable(shopsData);
  });

  function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const filter = filterSelect.value;
    let filtered = shopsData;

    if (filter === 'approved') filtered = filtered.filter(s => s.isApproved);
    else if (filter === 'notapproved') filtered = filtered.filter(s => !s.isApproved);
    else if (filter === 'trial') filtered = filtered.filter(s => s.subscriptionStatus === 'trial');
    else if (filter === 'subscription') filtered = filtered.filter(s => s.subscriptionStatus !== 'trial' && s.isApproved);

    if (searchTerm) {
      filtered = filtered.filter(s =>
        (s.mobileNo && s.mobileNo.toLowerCase().includes(searchTerm)) ||
        (s.shopName && s.shopName.toLowerCase().includes(searchTerm))
      );
    }
    renderTable(filtered);
  }

  window.onload = () => {};

</script>

</body>
</html>
