<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - RepariFy</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    font-family: 'Poppins', sans-serif;
    padding-top: 80px;
    background-color: #f8f9fa;
  }
  .container {
    max-width: 1150px;
  }
  h2 {
    font-weight: 700;
    color: #007bff;
    margin-bottom: 20px;
  }
  .table-responsive {
    max-height: 600px;
    overflow-y: auto;
  }
  .btn-primary, .btn-success, .btn-danger {
    min-width: 100px;
  }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-dark">
  <div class="container d-flex justify-content-between align-items-center">
    <a class="navbar-brand" href="#">RepariFy Admin Panel</a>
    <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
  </div>
</nav>

<div class="container">
  <h2>Manage Shops and Plans</h2>
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Shop ID</th>
          <th>Shop Name</th>
          <th>Email</th>
          <th>Mobile</th>
          <th>Plan</th>
          <th>Price (₹)</th>
          <th>Subscription Ends</th>
          <th>Approved</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="shopListBody">
        <tr><td colspan="9" class="text-center text-muted">Loading shops...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBCalxCVKnVERmpLnnCjT0X9Basy3uw7o",
    authDomain: "reparify-4db99.firebaseapp.com",
    projectId: "reparify-4db99",
    storageBucket: "reparify-4db99.appspot.com",
    messagingSenderId: "1039139563247",
    appId: "1:1039139563247:web:b93c63206f03433de11d1a",
    measurementId: "G-QP5QS2WJJX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore();
  const auth = getAuth();

  // Logout Button
  document.getElementById('logoutBtn').addEventListener('click', () => {
    signOut(auth).then(() => {
      window.location.href = 'login.html';
    });
  });

  // Redirect non-admin users off this page
  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    if (user.email !== 'admin@repari.fy') {
      alert("Access Denied: You are not authorized.");
      auth.signOut();
      window.location.href = 'login.html';
    }
  });

  const shopListBody = document.getElementById('shopListBody');

  async function loadShopList() {
    const shopsSnap = await getDocs(collection(db, 'shops'));
    if (shopsSnap.empty) {
      shopListBody.innerHTML = `<tr><td colspan="9" class="text-center">No shops found.</td></tr>`;
      return;
    }
    shopListBody.innerHTML = '';
    shopsSnap.forEach(docSnap => {
      const data = docSnap.data();
      const docId = docSnap.id;
      const subEndDate = data.subscriptionEnds ? data.subscriptionEnds.toDate().toLocaleDateString() : 'N/A';
      const approvedBadge = data.isApproved ? `<span class="badge bg-success">Approved</span>` : `<span class="badge bg-warning">Pending</span>`;
      const planPriceMap = {
        trial: 'Free',
        '6months': '5999',
        '1year': '10999',
        '2years': '19999'
      };
      const currentPrice = planPriceMap[data.subscriptionStatus] || 'N/A';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${docId}</td>
        <td>${data.shopName}</td>
        <td>${data.email}</td>
        <td>${data.mobileNo}</td>
        <td>
          <select class="form-select" data-doc-id="${docId}">
            <option value="trial" ${data.subscriptionStatus === 'trial' ? 'selected' : ''}>Trial</option>
            <option value="6months" ${data.subscriptionStatus === '6months' ? 'selected' : ''}>6 Months</option>
            <option value="1year" ${data.subscriptionStatus === '1year' ? 'selected' : ''}>1 Year</option>
            <option value="2years" ${data.subscriptionStatus === '2years' ? 'selected' : ''}>2 Years</option>
          </select>
        </td>
        <td>₹${currentPrice}</td>
        <td>${subEndDate}</td>
        <td>${approvedBadge}</td>
        <td>
          <button class="btn btn-success btn-sm approve-btn" data-doc-id="${docId}">Approve</button>
          <button class="btn btn-danger btn-sm revoke-btn" data-doc-id="${docId}">Revoke</button>
        </td>
      `;
      shopListBody.appendChild(tr);
    });

    attachEventListeners();
  }

  function attachEventListeners() {
    document.querySelectorAll('.approve-btn').forEach(btn =>
      btn.addEventListener('click', () => toggleApproval(btn.dataset.docId, true))
    );
    document.querySelectorAll('.revoke-btn').forEach(btn =>
      btn.addEventListener('click', () => toggleApproval(btn.dataset.docId, false))
    );
    document.querySelectorAll('select.form-select').forEach(sel =>
      sel.addEventListener('change', e => changePlan(e.target.dataset.docId, e.target.value))
    );
  }

  async function toggleApproval(docId, approve) {
    const confirmation = approve ? 'Approve this shop?' : 'Revoke approval?';
    if (!confirm(confirmation)) return;

    try {
      let subscriptionEnds = null;

      if (approve) {
        const select = document.querySelector(`select[data-doc-id="${docId}"]`);
        const plan = select ? select.value : 'trial';

        switch (plan) {
          case '6months':
            subscriptionEnds = new Date(Date.now() + 6 * 30 * 24 * 60 * 60 * 1000);
            break;
          case '1year':
            subscriptionEnds = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000);
            break;
          case '2years':
            subscriptionEnds = new Date(Date.now() + 2 * 365 * 24 * 60 * 60 * 1000);
            break;
          default:
            subscriptionEnds = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
        }
      }

      await updateDoc(doc(db, 'shops', docId), {
        isApproved: approve,
        subscriptionStatus: approve ? (document.querySelector(`select[data-doc-id="${docId}"]`).value) : 'revoked',
        subscriptionEnds: subscriptionEnds,
        updatedAt: serverTimestamp()
      });

      alert(`Shop ${approve ? 'approved' : 'revoked'} successfully`);
      loadShopList();
    } catch (err) {
      alert('Failed to update: ' + err.message);
      console.error(err);
    }
  }

  async function changePlan(docId, newPlan) {
    try {
      let subscriptionEnds = null;

      switch (newPlan) {
        case '6months':
          subscriptionEnds = new Date(Date.now() + 6 * 30 * 24 * 60 * 60 * 1000);
          break;
        case '1year':
          subscriptionEnds = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000);
          break;
        case '2years':
          subscriptionEnds = new Date(Date.now() + 2 * 365 * 24 * 60 * 60 * 1000);
          break;
        default:
          subscriptionEnds = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
      }

      await updateDoc(doc(db, 'shops', docId), {
        subscriptionStatus: newPlan,
        subscriptionEnds: subscriptionEnds,
        updatedAt: serverTimestamp()
      });

      alert('Plan updated successfully');
      loadShopList();
    } catch (err) {
      alert('Failed to update plan: ' + err.message);
      console.error(err);
    }
  }

  window.onload = () => {
    loadShopList();
  };
</script>

</body>
</html>
