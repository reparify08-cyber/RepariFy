<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RepariFy Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
      padding-top: 80px;
    }
    .dashboard-container {
      max-width: 1200px;
      margin: auto;
    }
    .nav-tabs .nav-link.active {
      font-weight: 600;
    }
    .table-responsive {
      max-height: 450px;
      overflow-y: auto;
    }
    .btn-actions > button {
      margin-right: 4px;
    }
    .service-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .service-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .service-card.selected {
        border: 3px solid #007bff !important;
        background-color: #e7f0ff;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid d-flex justify-content-between">
    <a class="navbar-brand" href="#">RepariFy Dashboard</a>
    <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
  </div>
</nav>

<div class="container dashboard-container mt-3">
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="mobile-tab" data-bs-toggle="tab" data-bs-target="#mobile" type="button" role="tab" aria-controls="mobile" aria-selected="true">Mobile Repair</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="computer-tab" data-bs-toggle="tab" data-bs-target="#computer" type="button" role="tab" aria-controls="computer" aria-selected="false">Computer Repair</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="unlocking-tab" data-bs-toggle="tab" data-bs-target="#unlocking" type="button" role="tab" aria-controls="unlocking" aria-selected="false">Unlocking Service</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="mobile" role="tabpanel" aria-labelledby="mobile-tab">
      <h4>New Mobile Repair Job</h4>
      <form id="mobileJobForm">
        <div class="mb-3">
          <input type="text" id="mCustomerName" class="form-control" placeholder="Customer Name" required />
        </div>
        <div class="mb-3">
          <input type="tel" id="mCustomerMobile" class="form-control" placeholder="Mobile No (WhatsApp)" required />
        </div>
        <div class="mb-3">
          <input type="text" id="mDeviceModel" class="form-control" placeholder="Device Model (e.g. Samsung A50)" required />
        </div>
        <div class="mb-3">
          <input type="text" id="mImei" class="form-control" placeholder="IMEI Number (15 digits)" pattern="\\d{15}" maxlength="15" />
        </div>
        <div class="mb-3">
          <textarea id="mIssueDesc" class="form-control" placeholder="Issue Description" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary w-100">Create Mobile Job</button>
      </form>
    </div>

    <div class="tab-pane fade" id="computer" role="tabpanel" aria-labelledby="computer-tab">
      <h4>New Computer Repair Job</h4>
      <form id="computerJobForm">
        <div class="mb-3">
          <input type="text" id="cCustomerName" class="form-control" placeholder="Customer Name" required />
        </div>
        <div class="mb-3">
          <input type="tel" id="cCustomerMobile" class="form-control" placeholder="Mobile No (WhatsApp)" required />
        </div>
        <div class="mb-3">
          <select id="cDeviceBrand" class="form-select" required>
            <option value="" disabled selected>Select Brand</option>
            <option value="Dell">Dell</option>
            <option value="HP">HP</option>
            <option value="Lenovo">Lenovo</option>
            <option value="Acer">Acer</option>
            <option value="Asus">Asus</option>
            <option value="Apple">Apple</option>
          </select>
        </div>
        <div class="mb-3">
          <input type="text" id="cDeviceModel" class="form-control" placeholder="Model Number" required />
        </div>
        <div class="mb-3">
          <textarea id="cIssueDesc" class="form-control" placeholder="Issue Description" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary w-100">Create Computer Job</button>
      </form>
    </div>

    <div class="tab-pane fade" id="unlocking" role="tabpanel" aria-labelledby="unlocking-tab">
      <h4 class="mb-4">Order Online Unlocking Service</h4>
      
      <div class="alert alert-info" role="alert">
          **Your Shop:** <span id="unlockShopName" class="fw-bold">...</span> | **Contact:** <span id="unlockShopContact">...</span>
      </div>

      <div class="row">
          <div class="col-md-5">
              <h5>1. Select Service (Rates set by Admin)</h5>
              <div id="unlocking-services-list" class="row g-3 mb-4">
                  <p class="text-muted">Loading available services...</p>
              </div>
          </div>
          <div class="col-md-7 border-start">
              <h5>2. Fill Device Details & Order</h5>
              <form id="unlockingOrderForm">
                  <input type="hidden" id="serviceId" required />
                  <input type="hidden" id="servicePrice" required />

                  <div class="mb-3">
                      <label class="form-label">Customer Name</label>
                      <input type="text" id="uCustomerName" class="form-control" required />
                  </div>
                  <div class="mb-3">
                      <label class="form-label">Customer Mobile (WhatsApp)</label>
                      <input type="tel" id="uCustomerMobile" class="form-control" required />
                  </div>
                  <div class="mb-3">
                      <label class="form-label">Brand & Model</label>
                      <input type="text" id="uBrandModel" class="form-control" required />
                  </div>
                  <div class="mb-3">
                      <label class="form-label">IMEI Number</label>
                      <input type="text" id="uImei" class="form-control" pattern="\\d{15}" maxlength="15" required />
                  </div>
                  <div class="mb-3">
                      <label class="form-label">Selected Service:</label>
                      <p class="fw-bold text-primary" id="selectedServiceName">None Selected</p>
                      <p class="fw-bold text-success">Price: ₹<span id="displayServicePrice">0</span></p>
                  </div>
                  
                  <button type="submit" class="btn btn-success w-100" id="orderUnlockBtn" disabled>
                      Place Order & Pay Technician
                  </button>
                  <p class="text-danger mt-2" id="orderErrorMsg"></p>
              </form>
          </div>
      </div>
    </div>
  </div>

  <h4 class="mt-4">Recent Jobs</h4>
  <div class="table-responsive">
    <table class="table table-striped table-hover" id="jobsTable">
      <thead>
        <tr class="bg-light">
          <th>Job ID</th>
          <th>Device Type</th>
          <th>Customer Name</th>
          <th>Mobile No.</th>
          <th>Device Model</th>
          <th>IMEI Number</th>
          <th>Status</th>
          <th>Estimated Cost (₹)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="jobs-table-body">
        <tr><td colspan="9" class="text-center text-muted">Loading recent jobs...</td></tr>
      </tbody>
    </table>
  </div>

  <h4 class="mt-4">Recent Unlocking Orders</h4>
  <div class="table-responsive">
    <table class="table table-striped table-hover" id="unlockOrdersTable">
      <thead>
        <tr class="bg-info text-white">
          <th>Order ID</th>
          <th>Service Name</th>
          <th>Device Model</th>
          <th>Customer Price (₹)</th>
          <th>Tech Name</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="unlock-orders-table-body">
        <tr><td colspan="7" class="text-center text-muted">No recent unlocking orders found.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="editJobModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" id="editJobForm">
      <div class="modal-header">
        <h5 class="modal-title">Update Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editJobId" />
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="editDeviceType" class="form-label">Device Type</label>
            <select id="editDeviceType" class="form-select" required>
              <option value="mobile">Mobile Phone</option>
              <option value="computer">Computer / Laptop</option>
              <option value="unlocking">Unlocking Service</option>
            </select>
          </div>
          <div class="col-md-8">
            <label for="editDeviceName" class="form-label">Device Model</label>
            <input type="text" id="editDeviceName" class="form-control" required />
          </div>
        </div>
        <div class="mb-3">
          <label for="editCustomerName" class="form-label">Customer Name</label>
          <input type="text" id="editCustomerName" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="editCustomerMobile" class="form-label">Customer Mobile</label>
          <input type="text" id="editCustomerMobile" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="editImeiNumber" class="form-label">IMEI Number</label>
          <input type="text" id="editImeiNumber" class="form-control" />
        </div>
        <div class="mb-3">
          <label for="editIssueDescription" class="form-label">Issue Description</label>
          <textarea id="editIssueDescription" class="form-control" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label for="editCurrentStatus" class="form-label">Current Status</label>
          <select id="editCurrentStatus" class="form-select" required>
            <option value="Received">Received for Inspection</option>
            <option value="InProgress">Repair In Progress</option>
            <option value="PartsWaiting">Waiting for Parts</option>
            <option value="Ready">Ready for Delivery</option>
            <option value="Delivered">Delivered</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="editEstimatedCost" class="form-label">Estimated Cost (₹)</label>
          <input type="number" id="editEstimatedCost" class="form-control" />
        </div>
        <hr/>
        <div class="mb-3">
          <button type="button" class="btn btn-outline-info" id="managePartsBtn">Manage Parts</button>
        </div>
        <div id="partsContainer"></div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  doc,
  getDoc,
  query,
  where,
  limit,
  updateDoc,
  serverTimestamp,
  getDocs
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBCalxCVKnVERmpLnnCjT0X9Basy3uw7o",
  authDomain: "reparify-4db99.firebaseapp.com",
  projectId: "reparify-4db99",
  storageBucket: "reparify-4db99.appspot.com",
  messagingSenderId: "1039139563247",
  appId: "1:1039139563247:web:b93c63206f03433de11d1a",
  measurementId: "G-QP5QS2WJJX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let currentUserId = null;
let shopData = null;
let activeTechnicians = []; 

onAuthStateChanged(auth, user => {
  if (user) {
    currentUserId = user.uid;
    getDoc(doc(db, "shops", currentUserId))
      .then(docSnap => {
        if (docSnap.exists() && docSnap.data().isApproved) {
          shopData = docSnap.data();
          document.title = `Dashboard - ${shopData.shopName}`;
          listenForJobs();
          listenForUnlockRates();
          listenForUnlockOrders();
          listenForTechnicians();
          fillUnlockingShopDetails();
        } else {
          alert("Access denied, not approved or revoked.");
          signOut(auth);
          window.location.href = "login.html";
        }
      })
      .catch(err => {
        console.error("Shop fetch error", err);
        signOut(auth);
        window.location.href = "login.html";
      });
  } else {
    window.location.href = "login.html";
  }
});

document.getElementById("logoutBtn").addEventListener("click", () =>
  signOut(auth).then(() => {
    window.location.href = "login.html";
  })
);

// --- Shop Data Display ---
function fillUnlockingShopDetails() {
    if (shopData) {
        document.getElementById("unlockShopName").textContent = shopData.shopName || "N/A";
        document.getElementById("unlockShopContact").textContent = shopData.mobileNo || "N/A";
    }
}

// --- Technician Listener (for assigning orders) ---
function listenForTechnicians() {
    const q = query(collection(db, "technicians"), where("status", "==", "Active"));
    onSnapshot(q, (snapshot) => {
        activeTechnicians = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (activeTechnicians.length === 0) {
            document.getElementById("orderErrorMsg").textContent = "No technicians are currently active to take orders.";
            document.getElementById("orderUnlockBtn").disabled = true;
        } else {
            document.getElementById("orderErrorMsg").textContent = "";
        }
    });
}

// --- Order Assignment Logic (Simple Round-Robin Placeholder) ---
let lastAssignedTechIndex = -1;
function getNextTechnicianId() {
    if (activeTechnicians.length === 0) return null;
    lastAssignedTechIndex = (lastAssignedTechIndex + 1) % activeTechnicians.length;
    return activeTechnicians[lastAssignedTechIndex].id;
}


// --- Form Submissions ---
document.getElementById("mobileJobForm").addEventListener("submit", e => {
  e.preventDefault();
  createJob("mobile");
});

document.getElementById("computerJobForm").addEventListener("submit", e => {
  e.preventDefault();
  createJob("computer");
});

document.getElementById("unlockingOrderForm").addEventListener("submit", e => {
  e.preventDefault();
  createUnlockOrder();
});

// --- Create local job function ---
async function createJob(type) {
  if (!currentUserId || !shopData) {
    alert("User data missing, please refresh.");
    return;
  }
  const formId = type === "mobile" ? "mobileJobForm" : "computerJobForm";
  const form = document.getElementById(formId);
  const isMobile = type === "mobile";

  const newJob = {
    customerName: form.querySelector(`input[id$='CustomerName']`).value.trim(),
    customerMobile: form.querySelector(`input[id$='CustomerMobile']`).value.trim(),
    deviceType: type,
    deviceName: form.querySelector(isMobile ? "#mDeviceModel" : "#cDeviceModel").value.trim(),
    // Fix: Computer job will have an empty IMEI string, preventing pattern error
    imeiNumber: isMobile ? form.querySelector("#mImei").value.trim().toUpperCase() : "", 
    issueDescription: form.querySelector("textarea").value.trim(),
    currentStatus: "Received",
    estimatedCost: 0, 
    receivedOn: serverTimestamp(),
    shopId: currentUserId,
    shopName: shopData.shopName || "",
    parts: [],
    workStartTime: null
  };

  try {
    const docRef = await addDoc(collection(db, "jobs"), newJob);
    alert("Job card created successfully!");
    jobPrintConfirm(newJob, docRef.id);
    form.reset();
  } catch (err) {
    alert("Failed to create job card! Please try again.");
    console.error(err);
  }
}

// --- Online Unlocking Order Creation ---
async function createUnlockOrder() {
    if (!currentUserId || activeTechnicians.length === 0) {
        alert("Cannot place order: No active technicians.");
        return;
    }

    const form = document.getElementById("unlockingOrderForm");
    const technicianId = getNextTechnicianId(); 
    
    if (!technicianId) {
        alert("No technician could be assigned.");
        return;
    }

    const orderData = {
        customerName: form.uCustomerName.value.trim(),
        customerMobile: form.uCustomerMobile.value.trim(),
        deviceName: form.uBrandModel.value.trim(),
        imeiNumber: form.uImei.value.trim().toUpperCase(),
        
        serviceId: form.serviceId.value,
        serviceName: document.getElementById("selectedServiceName").textContent,
        servicePrice: parseFloat(form.servicePrice.value), // Price shop pays
        
        shopId: currentUserId,
        shopName: shopData.shopName || "",
        
        technicianId: technicianId,
        status: "Pending", // Status for the technician to pick up
        orderedAt: serverTimestamp()
    };
    
    try {
        await addDoc(collection(db, "unlockOrders"), orderData);
        alert(`Unlocking order placed successfully! Assigned to Tech: ${technicianId.substring(0, 4)}...`);
        form.reset();
        document.getElementById("selectedServiceName").textContent = "None Selected";
        document.getElementById("displayServicePrice").textContent = "0";
        document.getElementById("orderUnlockBtn").disabled = true;
        // Deselect card
        document.querySelectorAll('.service-card').forEach(card => card.classList.remove('selected'));

    } catch (err) {
        alert("Failed to place unlocking order. Please try again.");
        console.error(err);
    }
}

// --- Live Unlocking Rate Display ---
function listenForUnlockRates() {
    const servicesList = document.getElementById("unlocking-services-list");
    onSnapshot(collection(db, "unlockRates"), (snapshot) => {
        servicesList.innerHTML = '';
        if (snapshot.empty) {
            servicesList.innerHTML = `<p class="text-danger">No unlocking services are currently available. Contact Admin.</p>`;
            return;
        }

        snapshot.forEach(doc => {
            const service = doc.data();
            const serviceHtml = `
                <div class="col-md-6">
                    <div class="card p-3 service-card" data-id="${doc.id}" data-name="${service.serviceName}" data-price="${service.price}">
                        <h6 class="card-title text-primary">${service.serviceName}</h6>
                        <p class="card-text mb-0">Price: <span class="fw-bold text-success">₹${service.price.toLocaleString('en-IN')}</span></p>
                        <p class="card-text text-muted" style="font-size:0.9em;">Duration: ${service.duration || 'N/A'}</p>
                    </div>
                </div>
            `;
            servicesList.insertAdjacentHTML('beforeend', serviceHtml);
        });

        // Attach click listener to cards
        document.querySelectorAll('.service-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                
                const serviceId = card.dataset.id;
                const serviceName = card.dataset.name;
                const servicePrice = card.dataset.price;
                
                document.getElementById("serviceId").value = serviceId;
                document.getElementById("servicePrice").value = servicePrice;
                document.getElementById("selectedServiceName").textContent = serviceName;
                document.getElementById("displayServicePrice").textContent = parseFloat(servicePrice).toLocaleString('en-IN');
                document.getElementById("orderUnlockBtn").disabled = false;
            });
        });
    });
}

// --- Recent jobs listener (Local Repair) ---
function listenForJobs() {
  const q = query(collection(db, "jobs"), where("shopId", "==", currentUserId), limit(15));
  onSnapshot(
    q,
    snapshot => {
      const tbody = document.getElementById("jobs-table-body");
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No recent local jobs found.</td></tr>`;
        return;
      }
      snapshot.forEach(doc => {
        const job = doc.data();
        const displayId = doc.id.substring(0, 5).toUpperCase();
        const statusClass = {
          Received: "bg-primary",
          InProgress: "bg-warning text-dark",
          PartsWaiting: "bg-danger",
          Ready: "bg-success",
          Delivered: "bg-secondary"
        }[job.currentStatus] || "bg-info";

        const row = `<tr>
          <td>${displayId}</td>
          <td>${job.deviceType.charAt(0).toUpperCase() + job.deviceType.slice(1)}</td>
          <td>${job.customerName}</td>
          <td>${job.customerMobile}</td>
          <td>${job.deviceName}</td>
          <td>${job.imeiNumber || "-"}</td>
          <td><span class="badge ${statusClass}">${job.currentStatus}</span></td>
          <td>₹${job.estimatedCost || 0}</td>
          <td class="btn-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="window.openEditModal('${doc.id}')">Update</button>
            <button class="btn btn-sm btn-outline-success" onclick="window.downloadJobPdf('${doc.id}')">PDF</button>
          </td>
        </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    },
    err => {
      console.error(err);
      const tbody = document.getElementById("jobs-table-body");
      tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error loading jobs.</td></tr>`;
    }
  );
}

// --- Recent Unlocking Orders Listener (Online Service) ---
function listenForUnlockOrders() {
    const q = query(collection(db, "unlockOrders"), where("shopId", "==", currentUserId), limit(15));
    onSnapshot(q, (snapshot) => {
        const tbody = document.getElementById("unlock-orders-table-body");
        tbody.innerHTML = '';
        if (snapshot.empty) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No recent unlocking orders found.</td></tr>`;
            return;
        }

        snapshot.forEach(doc => {
            const order = doc.data();
            const displayId = doc.id.substring(0, 5).toUpperCase();
            const date = order.orderedAt?.toDate ? order.orderedAt.toDate().toLocaleDateString('en-US') : 'N/A';
            const techName = order.technicianId ? `Tech ${order.technicianId.substring(0, 4)}...` : 'Unassigned';
            
            const statusClass = {
                Pending: "bg-warning text-dark",
                InProgress: "bg-info",
                Completed: "bg-success",
                Rejected: "bg-danger"
            }[order.status] || "bg-secondary";

            const row = `<tr>
                <td>${displayId}</td>
                <td>${order.serviceName}</td>
                <td>${order.deviceName}</td>
                <td>₹${order.servicePrice.toLocaleString('en-IN')}</td>
                <td>${techName}</td>
                <td><span class="badge ${statusClass}">${order.status}</span></td>
                <td>${date}</td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    });
}


// --- Job PDF Generation ---
window.downloadJobPdf = async function (jobId) {
    const docSnap = await getDoc(doc(db, "jobs", jobId));
    if (docSnap.exists()) {
        generateJobPdf(docSnap.data(), docSnap.id.substring(0, 5).toUpperCase());
    } else {
        alert("Job data not found.");
    }
}

function jobPrintConfirm(newJob, id){
  if(confirm("Do you want to download the job card PDF?")){
    generateJobPdf(newJob, id.substring(0, 5).toUpperCase());
  }
}

// Simplified PDF Generator
function generateJobPdf(data, id){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({format:'a4'});
  const pageWidth = pdf.internal.pageSize.getWidth();

  pdf.setFontSize(16);
  pdf.text(`Job Card ID: ${id}`, pageWidth/2, 15, {align:'center'});
  pdf.text(`Shop: ${shopData.shopName || ''}`, 15, 30);

  pdf.setFontSize(12);
  pdf.text(`Customer Name: ${data.customerName}`, 15, 40);
  pdf.text(`Mobile: ${data.customerMobile}`, 15, 50);
  pdf.text(`Device Type: ${data.deviceType.charAt(0).toUpperCase()+data.deviceType.slice(1)}`, 15, 60);
  pdf.text(`Device Model: ${data.deviceName}`, 15, 70);
  pdf.text(`IMEI Number: ${data.imeiNumber || '-'}`, 15, 80);
  pdf.text(`Issue: ${data.issueDescription}`, 15, 90);
  pdf.text(`Status: ${data.currentStatus}`, 15, 100);
  pdf.text(`Estimated Cost: ₹${data.estimatedCost || 0}`, 15, 110);

  if(data.parts && data.parts.length > 0){
    pdf.text("Extra Parts:", 15, 120);
    let totalPartCost = 0;
    data.parts.forEach((part,i) => {
      pdf.text(`- ${part.partName} x${part.quantity} @ ₹${part.price}`, 20, 130 + i*10);
      totalPartCost += part.quantity * part.price;
    });
    pdf.text(`Total Part Cost: ₹${totalPartCost}`, 15, 130 + data.parts.length * 10 + 5);
  }

  let datePrinted = new Date().toLocaleDateString('en-US');
  pdf.text(`Printed on: ${datePrinted}`, 15, 170);

  pdf.text("Powered by RepariFy Web", pageWidth/2, 280, {align: "center", fontSize: 8, fontStyle: "italic"});

  pdf.save(`JobCard_${id}.pdf`);
}


// --- Edit Modal Logic (Simplified & Corrected) ---
window.openEditModal = async function (jobId) {
    const modalEl = document.getElementById("editJobModal");
    const modal = new bootstrap.Modal(modalEl);
    const docSnap = await getDoc(doc(db, "jobs", jobId));
    if (!docSnap.exists()) {
        alert("Job not found.");
        return;
    }
    const job = docSnap.data();
    
    // Populate form fields
    document.getElementById("editJobId").value = jobId;
    document.getElementById("editCustomerName").value = job.customerName || "";
    document.getElementById("editCustomerMobile").value = job.customerMobile || "";
    document.getElementById("editDeviceType").value = job.deviceType || "mobile";
    document.getElementById("editDeviceName").value = job.deviceName || "";
    document.getElementById("editImeiNumber").value = job.imeiNumber || "";
    document.getElementById("editIssueDescription").value = job.issueDescription || "";
    document.getElementById("editCurrentStatus").value = job.currentStatus || "Received";
    document.getElementById("editEstimatedCost").value = job.estimatedCost || 0;

    // Setup Parts Manager with current job ID and data
    setupManagePartsModal(jobId, job.parts || []);
    
    modal.show();
};

document.getElementById("editJobForm").addEventListener("submit", async e => {
  e.preventDefault();
  const jobId = document.getElementById("editJobId").value;
  try {
    await updateDoc(doc(db, "jobs", jobId), {
      customerName: document.getElementById("editCustomerName").value.trim(),
      customerMobile: document.getElementById("editCustomerMobile").value.trim(),
      deviceType: document.getElementById("editDeviceType").value,
      deviceName: document.getElementById("editDeviceName").value.trim(),
      // Ensure IMEI is stored only if available
      imeiNumber: document.getElementById("editImeiNumber").value.trim().toUpperCase(), 
      issueDescription: document.getElementById("editIssueDescription").value.trim(),
      currentStatus: document.getElementById("editCurrentStatus").value,
      estimatedCost: parseFloat(document.getElementById("editEstimatedCost").value) || 0,
    });
    alert("Job updated!");
    bootstrap.Modal.getInstance(document.getElementById("editJobModal")).hide();
  } catch (err) {
    alert("Update failed: " + err.message);
    console.error(err);
  }
});

// --- Parts management modal (simplified & corrected) ---
function setupManagePartsModal(jobId, parts = []) {
  const partsContainer = document.getElementById("partsContainer");
  partsContainer.innerHTML = `<h6>Parts Used (${parts.length})</h6>`;

  parts.forEach((part) => {
    const partRow = document.createElement("div");
    partRow.classList.add("row", "mb-2");
    partRow.innerHTML = `
      <div class="col-5">
        <input type="text" class="form-control form-control-sm" value="${part.partName}" readonly />
      </div>
      <div class="col-3">
        <input type="number" class="form-control form-control-sm" value="${part.quantity}" readonly />
      </div>
      <div class="col-4">
        <input type="number" class="form-control form-control-sm" value="${part.price}" readonly />
      </div>
    `;
    partsContainer.appendChild(partRow);
  });
  
  // Set the job ID for the 'Manage Parts' button
  document.getElementById("managePartsBtn").dataset.jobId = jobId; 
}

document.getElementById("managePartsBtn").addEventListener("click", (e) => {
  const jobId = e.target.dataset.jobId;
  const partName = prompt("Enter part name:");
  if (!partName) return;

  const quantityStr = prompt("Enter quantity:");
  const quantity = parseInt(quantityStr, 10);
  if (isNaN(quantity) || quantity <= 0) return alert("Quantity must be a positive number.");

  const priceStr = prompt("Enter price (₹):");
  const price = parseFloat(priceStr);
  if (isNaN(price) || price < 0) return alert("Price must be a non-negative number.");

  getDoc(doc(db, "jobs", jobId))
    .then(docSnap => {
      const parts = docSnap.data().parts || [];
      parts.push({ partName, quantity, price });
      updateDoc(doc(db, "jobs", jobId), { parts })
        .then(() => {
          alert("Part added successfully.");
          // Re-setup modal to show new parts
          setupManagePartsModal(jobId, parts); 
        })
        .catch(err => alert("Failed to add part: " + err.message));
    })
    .catch(err => alert("Job not found: " + err.message));
});

</script>

</body>
</html>
