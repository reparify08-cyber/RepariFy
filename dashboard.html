<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RepariFy Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
      padding-top: 80px;
    }
    .dashboard-container {
      max-width: 1200px;
      margin: auto;
    }
    .nav-tabs .nav-link.active {
      font-weight: 600;
    }
    .table-responsive {
      max-height: 450px;
      overflow-y: auto;
    }
    .btn-actions > button {
      margin-right: 4px;
      margin-bottom: 4px;
    }
    .service-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .service-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .service-card.selected {
        border: 3px solid #007bff !important;
        background-color: #e7f0ff;
    }
    .logo-preview {
        max-width: 100px;
        max-height: 50px;
        object-fit: contain;
    }
    /* Hide dashboard until data loads to prevent flicker */
    #main-dashboard-content {
        display: none;
    }
    #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 10000;
    }
  </style>
</head>
<body>
<div id="loading-screen">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Checking authentication and loading shop data...</p>
</div>

<div id="main-dashboard-content">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid d-flex justify-content-between">
    <a class="navbar-brand" href="#">
        <img id="navLogo" src="" alt="Shop Logo" class="logo-preview me-2" style="display:none;"/> 
        <span id="navShopName">RepariFy Dashboard</span>
    </a>
    <div>
        <button id="logoUploadBtn" class="btn btn-outline-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#logoModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M12.735 6.255a.5.5 0 0 1-.5.5H11a.5.5 0 0 1-.447-.276L9.5 3.5a.5.5 0 0 1 .447-.724h.789a.5.5 0 0 1 .447.276L11.5 5.5a.5.5 0 0 1 .185.345.5.5 0 0 1 .046.01.5.5 0 0 1 .054.39"/>
              <path d="M4.406 1.394A5.5 5.5 0 0 1 13.993 4.5h-.005a.5.5 0 0 0 .5.5.5.5 0 0 1 .035.006.5.5 0 0 0 .146.046 6.507 6.507 0 0 0 1.258.118A6.5 6.5 0 0 0 0 6.03a.5.5 0 0 0 .5.495A5.5 5.5 0 0 1 12.735 6.255Z"/>
            </svg> Logo
        </button>
        <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
    </div>
  </div>
</nav>

<div class="container dashboard-container mt-3">
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="mobile-tab" data-bs-toggle="tab" data-bs-target="#mobile" type="button" role="tab" aria-controls="mobile" aria-selected="true">Mobile Repair</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="computer-tab" data-bs-toggle="tab" data-bs-target="#computer" type="button" role="tab" aria-controls="computer" aria-selected="false">Computer Repair</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="unlocking-legal-tab" data-bs-toggle="tab" data-bs-target="#unlocking-legal" type="button" role="tab" aria-controls="unlocking-legal" aria-selected="false">Unlocking Legal Terms</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="unlocking-online-tab" data-bs-toggle="tab" data-bs-target="#unlocking-online" type="button" role="tab" aria-controls="unlocking-online" aria-selected="false">Online Unlocking Order</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="daily-report-tab" data-bs-toggle="tab" data-bs-target="#daily-report" type="button" role="tab" aria-controls="daily-report" aria-selected="false">Daily Report</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="mobile" role="tabpanel" aria-labelledby="mobile-tab">
      <h4>New Mobile Repair Job</h4>
      <form id="mobileJobForm">
        <div class="mb-3"><input type="text" id="mCustomerName" class="form-control" placeholder="Customer Name" required /></div>
        <div class="mb-3"><input type="tel" id="mCustomerMobile" class="form-control" placeholder="Mobile No (WhatsApp)" required /></div>
        <div class="mb-3"><input type="text" id="mDeviceModel" class="form-control" placeholder="Device Model (e.g. Samsung A50)" required /></div>
        <div class="mb-3"><input type="text" id="mImei" class="form-control" placeholder="IMEI Number (15 digits)" maxlength="15" /></div>
        <div class="mb-3"><textarea id="mIssueDesc" class="form-control" placeholder="Issue Description" rows="3" required></textarea></div>
        <button type="submit" class="btn btn-primary w-100">Create Mobile Job & Generate Bill</button>
      </form>
    </div>

    <div class="tab-pane fade" id="computer" role="tabpanel" aria-labelledby="computer-tab">
      <h4>New Computer Repair Job</h4>
      <form id="computerJobForm">
        <div class="mb-3"><input type="text" id="cCustomerName" class="form-control" placeholder="Customer Name" required /></div>
        <div class="mb-3"><input type="tel" id="cCustomerMobile" class="form-control" placeholder="Mobile No (WhatsApp)" required /></div>
        <div class="mb-3">
          <select id="cDeviceBrand" class="form-select" required>
            <option value="" disabled selected>Select Brand</option>
            <option value="Dell">Dell</option>
            <option value="HP">HP</option>
            <option value="Lenovo">Lenovo</option>
            <option value="Acer">Acer</option>
            <option value="Asus">Asus</option>
            <option value="Apple">Apple</option>
          </select>
        </div>
        <div class="mb-3"><input type="text" id="cDeviceModel" class="form-control" placeholder="Model Number" required /></div>
        <div class="mb-3"><textarea id="cIssueDesc" class="form-control" placeholder="Issue Description" rows="3" required></textarea></div>
        <button type="submit" class="btn btn-primary w-100">Create Computer Job & Generate Bill</button>
      </form>
    </div>

    <div class="tab-pane fade" id="unlocking-legal" role="tabpanel" aria-labelledby="unlocking-legal-tab">
      <h4>Generate Legal Declaration for Unlocking</h4>
      <div class="alert alert-warning">
          **Shop Details:** <span id="unlockShopNameLegal" class="fw-bold">...</span> | **Contact:** <span id="unlockShopContactLegal">...</span>
      </div>
      <form id="legalDeclarationForm">
        <div class="row g-3">
            <div class="col-md-6"><label class="form-label">Brand & Model:</label><input type="text" id="ulBrandModel" class="form-control" required /></div>
            <div class="col-md-6"><label class="form-label">IMEI Number:</label><input type="text" id="ulImei" class="form-control" pattern="\\d{15}" maxlength="15" required /></div>
            <div class="col-12">
                <label class="form-label">Type of Unlocking Required:</label>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="ulPin" checked /><label class="form-check-label" for="ulPin">Pattern/PIN Unlock</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="ulFrp" /><label class="form-check-label" for="ulFrp">FRP (Google Account) Unlock</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="ulNetwork" /><label class="form-check-label" for="ulNetwork">Network Unlock</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="ulOthers" /><label class="form-check-label" for="ulOthers">Others</label></div>
            </div>
            <hr class="mt-4"/>
            <h5 class="col-12">Customer Details</h5>
            <div class="col-md-6"><label class="form-label">Full Name:</label><input type="text" id="ulFullName" class="form-control" required /></div>
            <div class="col-md-6"><label class="form-label">Phone Number:</label><input type="tel" id="ulPhoneNumber" class="form-control" required /></div>
            <div class="col-md-6"><label class="form-label">ID Type & Number (Aadhaar/Voter/etc.):</label><input type="text" id="ulIdTypeNumber" class="form-control" required /></div>
            <div class="col-md-6"><label class="form-label">Date:</label><input type="date" id="ulDate" class="form-control" required /></div>
            <div class="col-12"><label class="form-label">Address:</label><textarea id="ulAddress" class="form-control" rows="2" required></textarea></div>
        </div>
        <button type="submit" class="btn btn-danger w-100 mt-4">Generate & Print Legal Declaration PDF</button>
      </form>
    </div>

    <div class="tab-pane fade" id="unlocking-online" role="tabpanel" aria-labelledby="unlocking-online-tab">
      <h4 class="mb-4">Order Online Unlocking Service</h4>
      
      <div class="alert alert-info" role="alert">
          **Your Shop:** <span id="unlockShopNameOnline" class="fw-bold">...</span> | **Contact:** <span id="unlockShopContactOnline">...</span>
      </div>

      <div class="row">
          <div class="col-md-5">
              <h5>1. Select Service (Rates set by Admin)</h5>
              <div id="unlocking-services-list" class="row g-3 mb-4"><p class="text-muted">Loading available services...</p></div>
          </div>
          <div class="col-md-7 border-start">
              <h5>2. Fill Device Details & Order</h5>
              <form id="unlockingOrderForm">
                  <input type="hidden" id="serviceId" required />
                  <input type="hidden" id="servicePrice" required />

                  <div class="mb-3"><label class="form-label">Customer Name</label><input type="text" id="uCustomerName" class="form-control" required /></div>
                  <div class="mb-3"><label class="form-label">Customer Mobile (WhatsApp)</label><input type="tel" id="uCustomerMobile" class="form-control" required /></div>
                  <div class="mb-3"><label class="form-label">Brand & Model</label><input type="text" id="uBrandModel" class="form-control" required /></div>
                  <div class="mb-3"><label class="form-label">IMEI Number</label><input type="text" id="uImei" class="form-control" pattern="\\d{15}" maxlength="15" required /></div>
                  <div class="mb-3">
                      <label class="form-label">Selected Service:</label>
                      <p class="fw-bold text-primary" id="selectedServiceName">None Selected</p>
                      <p class="fw-bold text-success">Price: ₹<span id="displayServicePrice">0</span></p>
                  </div>
                  
                  <button type="submit" class="btn btn-success w-100" id="orderUnlockBtn" disabled>Place Order</button>
                  <p class="text-danger mt-2" id="orderErrorMsg"></p>
              </form>
          </div>
      </div>
    </div>
    
    <div class="tab-pane fade" id="daily-report" role="tabpanel" aria-labelledby="daily-report-tab">
        <h4>Daily Delivery & Income Report 📈</h4>
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="reportDate" class="form-label">Select Date:</label>
                <input type="date" id="reportDate" class="form-control" required />
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button id="generateReportBtn" class="btn btn-info w-100">Generate Report</button>
            </div>
        </div>
        <div id="reportSummary" class="mt-4 p-3 border rounded" style="display:none;">
            <h5 class="text-primary">Summary for <span id="summaryDate"></span></h5>
            <div class="row">
                <div class="col-md-6 mb-2">
                    <div class="card bg-light p-3">
                        Total Delivered Jobs: <span class="fw-bold text-success" id="totalDelivered">0</span>
                    </div>
                </div>
                <div class="col-md-6 mb-2">
                    <div class="card bg-light p-3">
                        Total Income: <span class="fw-bold text-success" id="totalIncome">₹0</span>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <p>Mobile Delivered: <span class="fw-bold" id="mobileDelivered">0</span></p>
                <p>Computer Delivered: <span class="fw-bold" id="computerDelivered">0</span></p>
            </div>
        </div>
        <div class="table-responsive mt-3">
            <table class="table table-striped table-hover" id="reportTable">
                <thead>
                    <tr class="bg-secondary text-white">
                        <th>Job ID</th>
                        <th>Device Type</th>
                        <th>Customer Name</th>
                        <th>Final Cost (₹)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="report-table-body">
                    <tr><td colspan="5" class="text-center text-muted">Select a date and generate the report.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
  </div>

  <h4 class="mt-4">Recent Jobs (Repair)</h4>
  <div class="table-responsive">
    <table class="table table-striped table-hover" id="jobsTable">
      <thead>
        <tr class="bg-light">
          <th>Job ID</th>
          <th>Device Type</th>
          <th>Customer Name</th>
          <th>Mobile No.</th>
          <th>Device Model</th>
          <th>Status</th>
          <th>Final Cost (₹)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="jobs-table-body">
        <tr><td colspan="8" class="text-center text-muted">Loading recent jobs...</td></tr>
      </tbody>
    </table>
  </div>

  <h4 class="mt-4">Recent Unlocking Orders (Online)</h4>
  <div class="table-responsive">
    <table class="table table-striped table-hover" id="unlockOrdersTable">
      <thead>
        <tr class="bg-info text-white">
          <th>Order ID</th>
          <th>Service Name</th>
          <th>Device Model</th>
          <th>Customer Price (₹)</th>
          <th>Tech Name</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="unlock-orders-table-body">
        <tr><td colspan="7" class="text-center text-muted">No recent unlocking orders found.</td></tr>
      </tbody>
    </table>
  </div>
</div>
</div>

<div class="modal fade" id="editJobModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" id="editJobForm">
      <div class="modal-header">
        <h5 class="modal-title">Update Job & Finalize Bill</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editJobId" />
        <div class="row mb-3">
          <div class="col-md-6"><label for="editDeviceType" class="form-label">Device Type</label><input type="text" id="editDeviceType" class="form-control" readonly /></div>
          <div class="col-md-6"><label for="editDeviceName" class="form-label">Device Model</label><input type="text" id="editDeviceName" class="form-control" required /></div>
        </div>
        <div class="mb-3"><label for="editIssueDescription" class="form-label">Issue Description</label><textarea id="editIssueDescription" class="form-control" rows="2" required></textarea></div>
        
        <div class="mb-3">
            <label for="editCurrentStatus" class="form-label">Current Status</label>
            <select id="editCurrentStatus" class="form-select" required>
                <option value="Received">Received for Inspection</option>
                <option value="InProgress">Repair In Progress</option>
                <option value="PartsWaiting">Waiting for Parts</option>
                <option value="Ready">Ready for Delivery</option>
                <option value="Delivered">Delivered</option>
                <option value="NotRepaired">Not Repaired (Unfixable)</option>
            </select>
        </div>
        <div class="mb-3"><label for="editServiceCharge" class="form-label">Service Charge (₹)</label><input type="number" id="editServiceCharge" class="form-control" value="0" min="0" /></div>
        <hr/>
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <h6>Parts Used (Final Bill Items)</h6>
            <button type="button" class="btn btn-outline-info btn-sm" id="managePartsBtn">Add/View Parts</button>
        </div>
        <div id="partsContainer" class="border p-2 rounded"></div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="logoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Shop Logo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Max size: 1MB. Recommended size: 200x100px.</p>
                <input type="file" class="form-control" id="logoFile" accept="image/*" />
                <div class="mt-3 text-center">
                    <h6>Current Logo:</h6>
                    <img id="currentLogoPreview" src="" alt="Current Logo" class="logo-preview border p-1" style="display:none;"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="uploadLogoConfirmBtn">Upload & Save</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  doc,
  getDoc,
  query,
  where,
  limit,
  updateDoc,
  serverTimestamp,
  getDocs
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

// !!! Replace with your Firebase config !!!
const firebaseConfig = {
  apiKey: "AIzaSyDBCalxCVKnVERmpLnnCjT0X9Basy3uw7o",
  authDomain: "reparify-4db99.firebaseapp.com",
  projectId: "reparify-4db99",
  storageBucket: "reparify-4db99.appspot.com",
  messagingSenderId: "1039139563247",
  appId: "1:1039139563247:web:b93c63206f03433de11d1a",
  measurementId: "G-QP5QS2WJJX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const storage = getStorage(app);

let currentUserId = null;
let shopData = null;
let activeTechnicians = []; 

// --- Core Auth Logic ---
// **FIX: Improved Authentication and Data Loading Logic**
onAuthStateChanged(auth, async user => {
  const loadingScreen = document.getElementById("loading-screen");
  const mainContent = document.getElementById("main-dashboard-content");

  if (user) {
    currentUserId = user.uid;
    try {
      const docSnap = await getDoc(doc(db, "shops", currentUserId));
      if (docSnap.exists() && docSnap.data().isApproved) {
        shopData = docSnap.data();
        document.title = `Dashboard - ${shopData.shopName}`;
        
        // Initialize UI components after data is safely loaded
        listenForJobs();
        listenForUnlockRates();
        listenForUnlockOrders();
        listenForTechnicians();
        fillShopDetails();
        setupLogoPreview();
        setupReportDate();

        // Show main content and hide loading screen
        mainContent.style.display = 'block';
        loadingScreen.style.display = 'none';

      } else {
        alert("Access denied, your shop is not approved or access has been revoked.");
        await signOut(auth);
        window.location.href = "login.html";
      }
    } catch (err) {
      console.error("Shop data loading error:", err);
      alert("Failed to load shop data. Please try logging in again.");
      await signOut(auth);
      window.location.href = "login.html";
    }
  } else {
    // Hide loading screen before redirecting
    loadingScreen.style.display = 'none'; 
    window.location.href = "login.html";
  }
});

document.getElementById("logoutBtn").addEventListener("click", () =>
  signOut(auth).then(() => {
    window.location.href = "login.html";
  })
);

// --- Shop Data & Logo Display (All same as previous version) ---
function fillShopDetails() {
    if (shopData) {
        document.getElementById("navShopName").textContent = shopData.shopName || "RepariFy Dashboard";
        document.getElementById("unlockShopNameLegal").textContent = shopData.shopName || "N/A";
        document.getElementById("unlockShopContactLegal").textContent = shopData.mobileNo || "N/A";
        document.getElementById("unlockShopNameOnline").textContent = shopData.shopName || "N/A";
        document.getElementById("unlockShopContactOnline").textContent = shopData.mobileNo || "N/A";
    }
}

function setupLogoPreview() {
    const logoImg = document.getElementById("navLogo");
    const currentLogoPreview = document.getElementById("currentLogoPreview");
    if (shopData && shopData.logoUrl) {
        logoImg.src = shopData.logoUrl;
        logoImg.style.display = 'inline-block';
        currentLogoPreview.src = shopData.logoUrl;
        currentLogoPreview.style.display = 'block';
    } else {
        logoImg.style.display = 'none';
        currentLogoPreview.style.display = 'none';
    }
}

// --- Logo Upload Logic (All same as previous version) ---
document.getElementById("uploadLogoConfirmBtn").addEventListener("click", async () => {
    const fileInput = document.getElementById("logoFile");
    const file = fileInput.files[0];
    if (!file) {
        alert("Please select a logo file to upload.");
        return;
    }
    if (file.size > 1048576) { // 1MB limit
        return alert("File size must be under 1MB.");
    }

    try {
        // 1. Delete old logo if it exists
        if (shopData && shopData.logoUrl) {
            const url = shopData.logoUrl;
            const pathMatch = url.match(/shop_logos%2F([^?]+)/);
            if(pathMatch){
                const oldPath = decodeURIComponent(pathMatch[1]);
                const oldRef = storageRef(storage, `shop_logos/${oldPath}`);
                await deleteObject(oldRef).catch(err => console.warn("Failed to delete old logo (might not exist):", err));
            }
        }

        // 2. Upload new logo
        const logoFileName = `${currentUserId}_logo_${Date.now()}`;
        const logoPath = `shop_logos/${logoFileName}`;
        const newRef = storageRef(storage, logoPath);
        const snapshot = await uploadBytes(newRef, file);
        const newLogoUrl = await getDownloadURL(snapshot.ref);

        // 3. Update Firestore with new URL
        await updateDoc(doc(db, "shops", currentUserId), { logoUrl: newLogoUrl });
        
        // 4. Update local data and UI
        shopData.logoUrl = newLogoUrl;
        setupLogoPreview();
        alert("Logo uploaded successfully!");
        bootstrap.Modal.getInstance(document.getElementById("logoModal")).hide();

    } catch (error) {
        console.error("Logo upload error:", error);
        alert("Logo upload failed. Please try again.");
    }
});


// --- Form Submissions (Same as previous version) ---
document.getElementById("mobileJobForm").addEventListener("submit", e => {
  e.preventDefault();
  createJob("mobile");
});

document.getElementById("computerJobForm").addEventListener("submit", e => {
  e.preventDefault();
  createJob("computer");
});

document.getElementById("legalDeclarationForm").addEventListener("submit", e => {
    e.preventDefault();
    generateLegalPdf();
});

document.getElementById("unlockingOrderForm").addEventListener("submit", e => {
  e.preventDefault();
  createUnlockOrder();
});

// --- Create local job function (Same as previous version) ---
async function createJob(type) {
  if (!currentUserId || !shopData) {
    alert("User data missing, please refresh.");
    return;
  }
  const formId = type === "mobile" ? "mobileJobForm" : "computerJobForm";
  const form = document.getElementById(formId);
  const isMobile = type === "mobile";

  const newJob = {
    customerName: form.querySelector(`input[id$='CustomerName']`).value.trim(),
    customerMobile: form.querySelector(`input[id$='CustomerMobile']`).value.trim(),
    deviceType: type,
    deviceName: form.querySelector(isMobile ? "#mDeviceModel" : "#cDeviceModel").value.trim(),
    imeiNumber: isMobile ? form.querySelector("#mImei").value.trim().toUpperCase() : "", 
    issueDescription: form.querySelector("textarea").value.trim(),
    currentStatus: "Received",
    serviceCharge: 0, 
    receivedOn: serverTimestamp(),
    deliveryDate: null, 
    shopId: currentUserId,
    shopName: shopData.shopName || "",
    parts: [],
  };

  try {
    const docRef = await addDoc(collection(db, "jobs"), newJob);
    alert("Job card created successfully!");
    jobPrintConfirm(newJob, docRef.id); 
    form.reset();
  } catch (err) {
    alert("Failed to create job card! Please try again.");
    console.error(err);
  }
}

// --- Live Work Streaming (WhatsApp Link Generator) (Same as previous version) ---
window.startWorkAndNotify = async function (jobId) {
    try {
        const docSnap = await getDoc(doc(db, "jobs", jobId));
        if (!docSnap.exists()) return alert("Job data not found.");
        const job = docSnap.data();

        if (job.currentStatus === 'Delivered' || job.currentStatus === 'NotRepaired') {
            return alert(`Job is already ${job.currentStatus}. Cannot start work.`);
        }

        // 1. Update status to InProgress
        await updateDoc(doc(db, "jobs", jobId), { currentStatus: "InProgress" });
        alert("Job status updated to 'Repair In Progress'.");

        // 2. Generate Dummy WhatsApp Link (Actual API call is Server Side)
        const liveStreamUrl = `https://your-server.com/live-stream/${jobId}`; // Placeholder link
        const whatsappMsg = encodeURIComponent(
            `*${shopData.shopName}* থেকে একটি নোটিফিকেশন:\n\nপ্রিয় ${job.customerName},\n\nআপনার *${job.deviceName}* ডিভাইসের কাজ শুরু হয়েছে। আপনি এই লিংকটিতে ক্লিক করে *লাইভ ভিডিও স্ট্রিমিং*-এর মাধ্যমে কাজটি দেখতে পারেন।\n\n🔗 *লাইভ লিংক:* ${liveStreamUrl}\n\nআপনার ডিভাইস ID: ${jobId.substring(0, 5).toUpperCase()}`
        );
        const mobileNumber = job.customerMobile.startsWith('+') ? job.customerMobile : `+91${job.customerMobile}`;
        const whatsappLink = `https://wa.me/${mobileNumber.replace('+', '').replace(/\s/g, '')}?text=${whatsappMsg}`;

        // 3. Open WhatsApp link for the user
        if (confirm("Status updated to 'In Progress'. Do you want to open WhatsApp to send the live stream link to the customer?")) {
            window.open(whatsappLink, '_blank');
        }

    } catch (err) {
        console.error("Work start error:", err);
        alert("Failed to start work or generate link.");
    }
}

// --- Recent jobs listener (Local Repair) (Same as previous version) ---
function listenForJobs() {
  const q = query(collection(db, "jobs"), where("shopId", "==", currentUserId), limit(20));
  onSnapshot(q, snapshot => {
      const tbody = document.getElementById("jobs-table-body");
      tbody.innerHTML = "";
      if (snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No recent local jobs found.</td></tr>`;
        return;
      }
      snapshot.forEach(doc => {
        const job = doc.data();
        const displayId = doc.id.substring(0, 5).toUpperCase();
        const statusClass = {
          Received: "bg-primary",
          InProgress: "bg-warning text-dark",
          PartsWaiting: "bg-danger",
          Ready: "bg-success",
          Delivered: "bg-secondary",
          NotRepaired: "bg-dark" 
        }[job.currentStatus] || "bg-info";
        const totalCost = (job.serviceCharge || 0) + (job.parts?.reduce((sum, p) => sum + (p.quantity * p.price), 0) || 0);

        const row = `<tr>
          <td>${displayId}</td>
          <td>${job.deviceType.charAt(0).toUpperCase() + job.deviceType.slice(1)}</td>
          <td>${job.customerName}</td>
          <td>${job.customerMobile}</td>
          <td>${job.deviceName}</td>
          <td><span class="badge ${statusClass}">${job.currentStatus}</span></td>
          <td>₹${totalCost.toLocaleString('en-IN')}</td>
          <td class="btn-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="window.openEditModal('${doc.id}')">Update/Bill</button>
            <button class="btn btn-sm btn-outline-success" onclick="window.downloadJobPdf('${doc.id}')">Print Bill</button>
            ${job.currentStatus !== 'Delivered' && job.currentStatus !== 'NotRepaired' ? 
              `<button class="btn btn-sm btn-warning text-dark" onclick="window.startWorkAndNotify('${doc.id}')">Start Work</button>` : ''}
          </td>
        </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    },
    err => {
      console.error(err);
      const tbody = document.getElementById("jobs-table-body");
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error loading jobs.</td></tr>`;
    }
  );
}

// --- Edit Modal Logic (Same as previous version) ---
window.openEditModal = async function (jobId) {
    const modalEl = document.getElementById("editJobModal");
    const modal = new bootstrap.Modal(modalEl);
    const docSnap = await getDoc(doc(db, "jobs", jobId));
    if (!docSnap.exists()) {
        alert("Job not found.");
        return;
    }
    const job = docSnap.data();
    
    document.getElementById("editJobId").value = jobId;
    document.getElementById("editDeviceType").value = job.deviceType.charAt(0).toUpperCase() + job.deviceType.slice(1);
    document.getElementById("editDeviceName").value = job.deviceName || "";
    document.getElementById("editIssueDescription").value = job.issueDescription || "";
    document.getElementById("editCurrentStatus").value = job.currentStatus || "Received";
    document.getElementById("editServiceCharge").value = job.serviceCharge || 0; 

    setupManagePartsModal(jobId, job.parts || []);
    
    modal.show();
};

document.getElementById("editJobForm").addEventListener("submit", async e => {
  e.preventDefault();
  const jobId = document.getElementById("editJobId").value;
  const newStatus = document.getElementById("editCurrentStatus").value;
  
  const updateData = {
      deviceName: document.getElementById("editDeviceName").value.trim(),
      issueDescription: document.getElementById("editIssueDescription").value.trim(),
      currentStatus: newStatus,
      serviceCharge: parseFloat(document.getElementById("editServiceCharge").value) || 0,
      deliveryDate: newStatus === 'Delivered' ? serverTimestamp() : null,
  };
  
  try {
    await updateDoc(doc(db, "jobs", jobId), updateData);
    alert("Job updated!");
    bootstrap.Modal.getInstance(document.getElementById("editJobModal")).hide();
  } catch (err) {
    alert("Update failed: " + err.message);
    console.error(err);
  }
});

// --- Parts management modal (Same as previous version) ---
function setupManagePartsModal(jobId, parts = []) {
  const partsContainer = document.getElementById("partsContainer");
  partsContainer.innerHTML = ''; 

  if (parts.length === 0) {
    partsContainer.innerHTML = `<p class="text-muted mb-0">No parts added yet.</p>`;
  } else {
    parts.forEach((part) => {
      const partRow = document.createElement("div");
      partRow.classList.add("row", "mb-2");
      partRow.innerHTML = `
        <div class="col-6"><input type="text" class="form-control form-control-sm" value="${part.partName}" readonly /></div>
        <div class="col-3"><input type="number" class="form-control form-control-sm" value="${part.quantity}" readonly /></div>
        <div class="col-3"><input type="number" class="form-control form-control-sm" value="${part.price}" readonly /></div>
      `;
      partsContainer.appendChild(partRow);
    });
  }
  
  document.getElementById("managePartsBtn").dataset.jobId = jobId; 
}

document.getElementById("managePartsBtn").addEventListener("click", (e) => {
  const jobId = e.target.dataset.jobId;
  const partName = prompt("Enter part name:");
  if (!partName) return;

  const quantityStr = prompt("Enter quantity (pieces):");
  const quantity = parseInt(quantityStr, 10);
  if (isNaN(quantity) || quantity <= 0) return alert("Quantity must be a positive number.");

  const priceStr = prompt("Enter Unit Price (₹):");
  const price = parseFloat(priceStr);
  if (isNaN(price) || price < 0) return alert("Price must be a non-negative number.");

  getDoc(doc(db, "jobs", jobId))
    .then(docSnap => {
      const parts = docSnap.data().parts || [];
      parts.push({ partName, quantity, price });
      updateDoc(doc(db, "jobs", jobId), { parts })
        .then(() => {
          alert("Part added successfully.");
          setupManagePartsModal(jobId, parts); 
        })
        .catch(err => alert("Failed to add part: " + err.message));
    })
    .catch(err => alert("Job not found: " + err.message));
});


// --- Daily Report Setup and Generation (Same as previous version) ---
function setupReportDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
}

document.getElementById("generateReportBtn").addEventListener("click", () => {
    const dateInput = document.getElementById("reportDate").value;
    if (!dateInput) return alert("Please select a date.");
    
    generateDailyReport(dateInput);
});

async function generateDailyReport(dateString) {
    const reportDate = new Date(dateString);
    reportDate.setHours(0, 0, 0, 0); 
    
    const nextDay = new Date(reportDate);
    nextDay.setDate(reportDate.getDate() + 1); 

    document.getElementById("summaryDate").textContent = reportDate.toLocaleDateString('en-IN');
    document.getElementById("reportSummary").style.display = 'block';
    
    const q = query(
        collection(db, "jobs"),
        where("shopId", "==", currentUserId),
        where("currentStatus", "==", "Delivered"),
        where("deliveryDate", ">=", reportDate),
        where("deliveryDate", "<", nextDay)
    );
    
    const tbody = document.getElementById("report-table-body");
    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-info">Generating report...</td></tr>`;

    try {
        const querySnapshot = await getDocs(q);
        let totalDelivered = 0;
        let totalIncome = 0;
        let mobileDelivered = 0;
        let computerDelivered = 0;
        
        tbody.innerHTML = "";

        if (querySnapshot.empty) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No jobs delivered on this date.</td></tr>`;
        } else {
            querySnapshot.forEach(docSnap => {
                const job = docSnap.data();
                const jobCost = (job.serviceCharge || 0) + (job.parts?.reduce((sum, p) => sum + (p.quantity * p.price), 0) || 0);
                totalIncome += jobCost;
                totalDelivered++;
                job.deviceType === 'mobile' ? mobileDelivered++ : computerDelivered++;
                
                const row = `<tr>
                    <td>${docSnap.id.substring(0, 5).toUpperCase()}</td>
                    <td>${job.deviceType.charAt(0).toUpperCase() + job.deviceType.slice(1)}</td>
                    <td>${job.customerName}</td>
                    <td>₹${jobCost.toLocaleString('en-IN')}</td>
                    <td><span class="badge bg-secondary">Delivered</span></td>
                </tr>`;
                tbody.insertAdjacentHTML("beforeend", row);
            });
        }
        
        document.getElementById("totalDelivered").textContent = totalDelivered;
        document.getElementById("totalIncome").textContent = `₹${totalIncome.toLocaleString('en-IN')}`;
        document.getElementById("mobileDelivered").textContent = mobileDelivered;
        document.getElementById("computerDelivered").textContent = computerDelivered;
        
    } catch (error) {
        console.error("Report generation error:", error);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error fetching report data.</td></tr>`;
    }
}


// --- Professional Purchase Bill PDF Generator (Same as previous version) ---
window.downloadJobPdf = async function (jobId) {
    const docSnap = await getDoc(doc(db, "jobs", jobId));
    if (docSnap.exists()) {
        const jobData = docSnap.data();
        await generateProfessionalBillPdf(jobData, docSnap.id.substring(0, 5).toUpperCase(), shopData.logoUrl);
    } else {
        alert("Job data not found.");
    }
}

function jobPrintConfirm(newJob, id){
  if(confirm("Do you want to download the initial Job Bill PDF?")){
    generateProfessionalBillPdf(newJob, id.substring(0, 5).toUpperCase(), shopData.logoUrl);
  }
}

async function generateProfessionalBillPdf(data, id, logoUrl){
  const pdf = new jsPDF({format:'a4'});
  const pageWidth = pdf.internal.pageSize.getWidth();
  
  // 1. Header (Shop Details - Updated with Logo)
  let headerY = 10;
  if (logoUrl) {
    try {
        const img = await loadImage(logoUrl);
        pdf.addImage(img, 'PNG', 10, headerY, 30, 15);
    } catch (e) {
        console.warn("Logo image failed to load for PDF.", e);
    }
  }

  pdf.setFontSize(14);
  pdf.setFont(pdf.getFontList().Helvetica, 'bold');
  pdf.text(shopData.shopName.toUpperCase() || 'REPARIFY MOBILE SOLUTION', 105, 10, {align: 'center'});
  pdf.setFontSize(9);
  pdf.setFont(pdf.getFontList().Helvetica, 'normal');
  pdf.text(`Branch: ${shopData.address || 'N/A'}`, 105, 15, {align: 'center'});
  pdf.text(`Contact: ${shopData.mobileNo || 'N/A'} | Email: ${shopData.email || 'N/A'}`, 105, 20, {align: 'center'});
  
  pdf.setLineWidth(0.5);
  pdf.line(10, 25, 200, 25); // Separator line

  // 2. Receipt Voucher Title
  pdf.setFontSize(11);
  pdf.setFont(pdf.getFontList().Helvetica, 'bold');
  pdf.text(data.currentStatus === 'Delivered' ? 'FINAL REPAIR INVOICE (JOB CARD)' : 'ADVANCE REPAIR RECEIPT VOUCHER (JOB CARD)', 105, 30, {align: 'center'});

  // 3. Details Boxes (Starting Y is 35)
  pdf.setLineWidth(0.2);
  pdf.rect(10, 35, 90, 35); // Left Box: Customer Details
  pdf.rect(110, 35, 90, 35); // Right Box: Device/Job Details

  pdf.setFontSize(9);
  pdf.setFont(pdf.getFontList().Helvetica, 'bold');
  pdf.text('Details of Customer (Billing Address)', 15, 40);
  pdf.setFont(pdf.getFontList().Helvetica, 'normal');
  pdf.text(`Name: ${data.customerName}`, 15, 45);
  pdf.text(`Contact: ${data.customerMobile}`, 15, 50);
  pdf.text(`Job ID: ${id}`, 15, 55);
  pdf.text(`Received On: ${data.receivedOn?.toDate ? data.receivedOn.toDate().toLocaleDateString('en-US') : 'N/A'}`, 15, 60);

  pdf.setFont(pdf.getFontList().Helvetica, 'bold');
  pdf.text('Details of Device/Repair', 115, 40);
  pdf.setFont(pdf.getFontList().Helvetica, 'normal');
  pdf.text(`Device: ${data.deviceName}`, 115, 45);
  pdf.text(`IMEI: ${data.imeiNumber || 'N/A'}`, 115, 50);
  pdf.text(`Issue: ${data.issueDescription.substring(0, 30)}...`, 115, 55);
  pdf.text(`Status: ${data.currentStatus}`, 115, 60);

  // 4. Job/Parts Table
  const tableHeaders = [['SL. No.', 'Description', 'Unit Price (₹)', 'Qty', 'Taxable Value (₹)']];
  const tableBody = [];
  let serial = 1;
  let subTotal = 0;
  
  const serviceCharge = parseFloat(data.serviceCharge || 0);
  if (serviceCharge > 0) {
      tableBody.push([
          serial++, 
          `Service Charge for ${data.deviceName} Repair`, 
          serviceCharge.toFixed(2), 
          1, 
          serviceCharge.toFixed(2)
      ]);
      subTotal += serviceCharge;
  }

  if(data.parts && data.parts.length > 0){
      data.parts.forEach(part => {
          const partPrice = parseFloat(part.price || 0);
          const totalPartValue = partPrice * (part.quantity || 1);
          tableBody.push([
              serial++, 
              `${part.partName} Replacement Part`, 
              partPrice.toFixed(2), 
              part.quantity || 1, 
              totalPartValue.toFixed(2)
          ]);
          subTotal += totalPartValue;
      });
  }

  if (tableBody.length === 0) {
      tableBody.push([1, 'Initial Inspection/Estimate (₹0.00)', '0.00', 1, '0.00']);
  }

  pdf.autoTable({
    startY: 75,
    head: tableHeaders,
    body: tableBody,
    styles: { fontSize: 8, cellPadding: 2 },
    headStyles: { fillColor: [230, 230, 230], textColor: [0, 0, 0], fontStyle: 'bold' },
    columnStyles: {
        0: { cellWidth: 10 }, 
        2: { halign: 'right' }, 
        3: { cellWidth: 15, halign: 'center' },
        4: { halign: 'right' }
    }
  });

  const finalY = pdf.lastAutoTable.finalY + 2;

  // 5. Total Section
  const totalAmountInWords = numToWords(subTotal) + " Only";
  
  pdf.setLineWidth(0.5);
  pdf.line(10, finalY, 200, finalY); 

  pdf.setFontSize(9);
  pdf.setFont(pdf.getFontList().Helvetica, 'bold');
  pdf.text('Total Amount (In Words):', 15, finalY + 5);
  pdf.text(totalAmountInWords, 55, finalY + 5);

  pdf.rect(140, finalY + 1, 60, 8); 
  pdf.text('Total Taxable Value (₹):', 142, finalY + 5);
  pdf.text(subTotal.toFixed(2), 198, finalY + 5, {align: 'right'});

  pdf.rect(140, finalY + 9, 60, 8); 
  pdf.text('GRAND TOTAL (₹):', 142, finalY + 13);
  pdf.text(subTotal.toFixed(2), 198, finalY + 13, {align: 'right'});

  // 6. Warranty Terms 
  const warrantyText = [
      "WARRANTY CONDITIONS (READ CAREFULLY):",
      "1. LCD/Display Replacements: 30 days warranty. Warranty applies ONLY to technical malfunction (no display/touch issue).",
      "2. Warranty VOID if: Physical damage, screen crack, liquid damage (water), pressure spots, dark spots, or if the screen seal/sticker is removed.",
      "3. All other spare parts (Battery, Speakers, etc.) are covered for 7 days unless specified otherwise.",
      "4. Data Loss: We are NOT responsible for any data loss during the repair process.",
      "5. I have checked the device before delivery and accept the repair conditions.",
      "6. *Not Repaired* status will incur an inspection charge of Rs. 150/- (or as agreed)."
  ];

  let currentY = finalY + 25;
  pdf.setFontSize(8);
  pdf.setFont(pdf.getFontList().Helvetica, 'bold');
  pdf.text(warrantyText[0], 10, currentY);
  currentY += 4;
  pdf.setFont(pdf.getFontList().Helvetica, 'normal');
  warrantyText.slice(1).forEach(line => {
      pdf.text(line, 10, currentY);
      currentY += 4;
  });
  
  // 7. Signature & Footer
  pdf.setLineWidth(0.2);
  pdf.line(150, currentY + 10, 200, currentY + 10);
  pdf.setFontSize(9);
  pdf.setFont(pdf.getFontList().Helvetica, 'bold');
  pdf.text('Authorised Signature', 175, currentY + 14, {align: 'center'});

  pdf.text("Customer Signature", 30, currentY + 14, {align: 'center'});
  pdf.line(10, currentY + 10, 60, currentY + 10);
  
  pdf.save(`Bill_${id}_${data.customerName.replace(/\s/g, '')}.pdf`);
}

// Helper to load image for jspdf (Same as previous version)
function loadImage(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous'; 
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Image failed to load.'));
        img.src = url;
    });
}

// --- Utility: Number to Words (Same as previous version) ---
function numToWords(n) {
    const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
    const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
    const g = ['', 'thousand', 'lakh', 'crore', 'arab'];
    const s = (num) => {
        let n = ('000' + num).substr(-3).split('');
        const h = parseInt(n[0]);
        const t = parseInt(n[1]);
        const u = parseInt(n[2]);
        let str = '';
        if (h > 0) str += a[h] + 'hundred ';
        if (t > 1) {
            str += b[t] + ' ';
            if (u > 0) str += a[u] + ' ';
        } else if (t == 1) {
            str += a[t * 10 + u] + ' ';
        } else if (u > 0) {
            str += a[u] + ' ';
        }
        return str;
    };

    if (typeof n !== 'number') return '';
    let x = n.toFixed(2).split('.');
    let num = parseInt(x[0]);
    let decimal = x.length > 1 ? parseInt(x[1]) : 0;
    let out = '';
    
    let parts = [];
    parts.push(num % 1000); 
    num = Math.floor(num / 1000);
    parts.push(num % 100); 
    num = Math.floor(num / 100);
    parts.push(num % 100); 
    num = Math.floor(num / 100);
    parts.push(num % 100); 
    num = Math.floor(num / 100);
    parts.push(num % 100); 

    for (let i = 0; i < parts.length; i++) {
        if (parts[i] !== 0) {
            out = s(parts[i]) + g[i] + ' ' + out;
        }
    }

    if (decimal > 0) {
        out += 'and ' + decimal.toString().padStart(2, '0') + '/100 ';
    }
    
    return out.trim().toUpperCase();
}

// --- Unlocking Order Logic (Same as previous version) ---
function listenForTechnicians() {
    const q = query(collection(db, "technicians"), where("status", "==", "Active"));
    onSnapshot(q, (snapshot) => {
        activeTechnicians = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (activeTechnicians.length === 0) {
            document.getElementById("orderErrorMsg").textContent = "No technicians are currently active to take orders.";
            document.getElementById("orderUnlockBtn").disabled = true;
        } else {
            document.getElementById("orderErrorMsg").textContent = "";
        }
    });
}

let lastAssignedTechIndex = -1;
function getNextTechnicianId() {
    if (activeTechnicians.length === 0) return null;
    lastAssignedTechIndex = (lastAssignedTechIndex + 1) % activeTechnicians.length;
    return activeTechnicians[lastAssignedTechIndex].id;
}

async function createUnlockOrder() {
    if (!currentUserId || activeTechnicians.length === 0) {
        alert("Cannot place order: No active technicians.");
        return;
    }
    const form = document.getElementById("unlockingOrderForm");
    const technicianId = getNextTechnicianId(); 
    
    if (!technicianId) {
        alert("No technician could be assigned.");
        return;
    }

    const orderData = {
        customerName: form.uCustomerName.value.trim(),
        customerMobile: form.uCustomerMobile.value.trim(),
        deviceName: form.uBrandModel.value.trim(),
        imeiNumber: form.uImei.value.trim().toUpperCase(),
        
        serviceId: form.serviceId.value,
        serviceName: document.getElementById("selectedServiceName").textContent,
        servicePrice: parseFloat(form.servicePrice.value), 
        
        shopId: currentUserId,
        shopName: shopData.shopName || "",
        
        technicianId: technicianId,
        status: "Pending", 
        orderedAt: serverTimestamp()
    };
    
    try {
        await addDoc(collection(db, "unlockOrders"), orderData);
        alert(`Unlocking order placed successfully! Assigned to Tech: ${technicianId.substring(0, 4)}...`);
        form.reset();
        document.getElementById("selectedServiceName").textContent = "None Selected";
        document.getElementById("displayServicePrice").textContent = "0";
        document.getElementById("orderUnlockBtn").disabled = true;
        document.querySelectorAll('.service-card').forEach(card => card.classList.remove('selected'));

    } catch (err) {
        alert("Failed to place unlocking order. Please try again.");
        console.error(err);
    }
}

function listenForUnlockRates() {
    const servicesList = document.getElementById("unlocking-services-list");
    onSnapshot(collection(db, "unlockRates"), (snapshot) => {
        servicesList.innerHTML = '';
        if (snapshot.empty) {
            servicesList.innerHTML = `<p class="text-danger">No unlocking services are currently available. Contact Admin.</p>`;
            document.getElementById("orderUnlockBtn").disabled = true;
            return;
        }
        document.getElementById("orderUnlockBtn").disabled = true; 
        snapshot.forEach(doc => {
            const service = doc.data();
            const serviceHtml = `
                <div class="col-md-6">
                    <div class="card p-3 service-card" data-id="${doc.id}" data-name="${service.serviceName}" data-price="${service.price}">
                        <h6 class="card-title text-primary">${service.serviceName}</h6>
                        <p class="card-text mb-0">Price: <span class="fw-bold text-success">₹${service.price.toLocaleString('en-IN')}</span></p>
                        <p class="card-text text-muted" style="font-size:0.9em;">Duration: ${service.duration || 'N/A'}</p>
                    </div>
                </div>
            `;
            servicesList.insertAdjacentHTML('beforeend', serviceHtml);
        });

        document.querySelectorAll('.service-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                
                const serviceId = card.dataset.id;
                const serviceName = card.dataset.name;
                const servicePrice = card.dataset.price;
                
                document.getElementById("serviceId").value = serviceId;
                document.getElementById("servicePrice").value = servicePrice;
                document.getElementById("selectedServiceName").textContent = serviceName;
                document.getElementById("displayServicePrice").textContent = parseFloat(servicePrice).toLocaleString('en-IN');
                document.getElementById("orderUnlockBtn").disabled = false;
            });
        });
    });
}

function listenForUnlockOrders() {
    const q = query(collection(db, "unlockOrders"), where("shopId", "==", currentUserId), limit(15));
    onSnapshot(q, (snapshot) => {
        const tbody = document.getElementById("unlock-orders-table-body");
        tbody.innerHTML = '';
        if (snapshot.empty) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No recent unlocking orders found.</td></tr>`;
            return;
        }

        snapshot.forEach(doc => {
            const order = doc.data();
            const displayId = doc.id.substring(0, 5).toUpperCase();
            const date = order.orderedAt?.toDate ? order.orderedAt.toDate().toLocaleDateString('en-US') : 'N/A';
            const techName = order.technicianId ? `Tech ${order.technicianId.substring(0, 4)}...` : 'Unassigned';
            
            const statusClass = {
                Pending: "bg-warning text-dark",
                InProgress: "bg-info",
                Completed: "bg-success",
                Rejected: "bg-danger"
            }[order.status] || "bg-secondary";

            const row = `<tr>
                <td>${displayId}</td>
                <td>${order.serviceName}</td>
                <td>${order.deviceName}</td>
                <td>₹${order.servicePrice.toLocaleString('en-IN')}</td>
                <td>${techName}</td>
                <td><span class="badge ${statusClass}">${order.status}</span></td>
                <td>${date}</td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    });
}

function generateLegalPdf() {
    const form = document.getElementById("legalDeclarationForm");
    const brandModel = form.ulBrandModel.value.trim();
    const imei = form.ulImei.value.trim();
    const fullName = form.ulFullName.value.trim();
    const address = form.ulAddress.value.trim();
    const phoneNumber = form.ulPhoneNumber.value.trim();
    const idTypeNumber = form.ulIdTypeNumber.value.trim();
    const dateInput = form.ulDate.value.split('-');
    const date = `${dateInput[2]}/${dateInput[1]}/${dateInput[0].substring(0,2)}${dateInput[0].substring(2)}`;
    
    let unlockTypes = [];
    if (form.ulPin.checked) unlockTypes.push("Pattern/PIN Unlock");
    if (form.ulFrp.checked) unlockTypes.push("FRP (Google Account) Unlock");
    if (form.ulNetwork.checked) unlockTypes.push("Network Unlock");
    if (form.ulOthers.checked) unlockTypes.push("Others");

    if (unlockTypes.length === 0) {
        alert("Please select at least one unlocking type.");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({format:"a4"});
    const pageWidth = pdf.internal.pageSize.getWidth();

    pdf.setFontSize(11);
    pdf.setFont(pdf.getFontList().Helvetica, 'normal');
    
    pdf.setFontSize(14);
    pdf.setFont(pdf.getFontList().Helvetica, 'bold');
    pdf.text("Declaration for Mobile Unlocking Service", 15, 15);

    pdf.setFontSize(11);
    pdf.setFont(pdf.getFontList().Helvetica, 'normal');
    pdf.text(`Shop Name: ${shopData.shopName || 'N/A'}`, 15, 25);
    pdf.text(`Shop Address: ${shopData.address || 'N/A'}`, 15, 30);
    pdf.text(`Contact Number: ${shopData.mobileNo || 'N/A'}`, 15, 35);
    
    const declarationPart1 = `I, the undersigned, hereby declare that I am the lawful owner/user of the mobile phone submitted for unlocking.`;
    pdf.text(declarationPart1, 15, 50);

    pdf.setFontSize(11);
    pdf.setFont(pdf.getFontList().Helvetica, 'normal');
    pdf.text("The details of the phone are as follows:", 15, 60);

    let y = 70;
    pdf.text(`Brand & Model: ${brandModel}`, 25, y); y += 10;
    pdf.text(`IMEI Number: ${imei}`, 25, y); y += 10;
    
    pdf.text("Type of Unlocking Required:", 25, y); y += 5;
    unlockTypes.forEach(type => {
        pdf.text(`[✓] ${type}`, 30, y); y += 5;
    });
    
    y += 10;
    pdf.setFontSize(10);
    pdf.setFont(pdf.getFontList().Helvetica, 'bold');
    pdf.text("I understand and agree that:", 15, y); y += 5;
    pdf.setFont(pdf.getFontList().Helvetica, 'normal');

    const legalTerms = [
        "1. This unlocking is being done at my own request and risk.",
        "2. The Mobile Solution and its technician(s) are not responsible for any data loss, damage, or legal issues.",
        "3. I confirm that the device is not stolen or involved in any criminal or unlawful activity.",
        "4. I am submitting a valid ID proof for record and verification purposes."
    ];
    legalTerms.forEach(term => {
        pdf.text(term, 20, y); y += 5;
    });

    y += 10;
    pdf.setFontSize(11);
    pdf.setFont(pdf.getFontList().Helvetica, 'bold');
    pdf.text("Customer Details:", 15, y); y += 5;
    pdf.setFont(pdf.getFontList().Helvetica, 'normal');
    
    pdf.text(`Full Name: ${fullName}`, 25, y); y += 10;
    pdf.text(`Address: ${address}`, 25, y); y += 10;
    pdf.text(`Phone Number: ${phoneNumber}`, 25, y); y += 10;
    pdf.text(`ID Type & Number: ${idTypeNumber}`, 25, y); y += 10;
    
    y += 10;
    pdf.text(`Date: ${date}`, 15, y);
    pdf.text("Customer Signature:", 130, y); y += 5;
    
    pdf.line(130, y, 190, y); 
    
    pdf.text("Powered by RepariFy Web", pageWidth/2, 280, {align: "center", fontSize: 8, fontStyle: "italic"});

    pdf.save(`UnlockingDeclaration_${fullName.replace(/\s/g, '')}.pdf`);
    alert("Legal Declaration PDF generated. Please print and obtain customer signature.");
}
</script>

</body>
</html>
